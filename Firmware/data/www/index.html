<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>KH Controller V3</title>
  <link rel="stylesheet" href="style.css?v=8">
</head>
<body>
  <header>
    <h1>KH Controller V3</h1>
    <div class="status-icons">
      <span id="ind-wifi" class="si" title="WiFi">
        <svg viewBox="0 0 20 16" width="14" height="11"><path d="M10 14a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" fill="currentColor"/><path d="M6 9.5a5.5 5.5 0 018 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M2.5 6a10.5 10.5 0 0115 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </span>
      <span id="ind-mqtt" class="si" title="MQTT">
        <svg viewBox="0 0 16 15" width="13" height="12"><path d="M1 1h14v9H8l-3 3v-3H1z" fill="currentColor"/></svg>
      </span>
      <span id="ind-ntp" class="si" title="NTP">
        <svg viewBox="0 0 16 16" width="13" height="13"><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M8 4.5V8l2.5 1.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </span>
      <span id="ind-ws" class="si" title="WebSocket">
        <svg viewBox="0 0 12 16" width="10" height="13"><path d="M7 1L3 9h3l-1 6 5-8H7z" fill="currentColor"/></svg>
      </span>
      <span id="ind-probe" class="si" title="Probe Health">
        <svg viewBox="0 0 12 24" width="8" height="16"><rect x="3" y="0" width="6" height="14" rx="3" fill="currentColor"/><rect x="5" y="14" width="2" height="10" fill="currentColor"/></svg>
      </span>
    </div>
  </header>

  <section class="gauges">
    <div class="gauge-card">
      <div class="gauge-visual">
        <svg viewBox="0 0 120 80" class="gauge-svg">
          <path d="M15 70 A50 50 0 0 1 105 70" fill="none" stroke="#333" stroke-width="8" stroke-linecap="round"/>
          <path id="gauge-kh-arc" d="M15 70 A50 50 0 0 1 105 70" fill="none" stroke="#0a84ff" stroke-width="8" stroke-linecap="round" stroke-dasharray="0 999"/>
        </svg>
      </div>
      <div class="gauge-value" id="val-kh">--</div>
      <div class="gauge-label">KH (dKH)</div>
    </div>
    <div class="gauge-card">
      <div class="gauge-visual">
        <svg viewBox="0 0 120 80" class="gauge-svg">
          <path d="M15 70 A50 50 0 0 1 105 70" fill="none" stroke="#333" stroke-width="8" stroke-linecap="round"/>
          <path id="gauge-ph-arc" d="M15 70 A50 50 0 0 1 105 70" fill="none" stroke="#30d158" stroke-width="8" stroke-linecap="round" stroke-dasharray="0 999"/>
        </svg>
      </div>
      <div class="gauge-value" id="val-ph">--</div>
      <div class="gauge-label">pH</div>
    </div>
    <div class="gauge-card">
      <div class="gauge-visual">
        <svg viewBox="0 0 120 80" class="gauge-svg">
          <path d="M15 70 A50 50 0 0 1 105 70" fill="none" stroke="#333" stroke-width="8" stroke-linecap="round"/>
          <path id="gauge-mesph-arc" d="M15 70 A50 50 0 0 1 105 70" fill="none" stroke="#ff9f0a" stroke-width="8" stroke-linecap="round" stroke-dasharray="0 999"/>
        </svg>
      </div>
      <div class="gauge-value" id="val-mesph">--</div>
      <div class="gauge-label">Measured pH</div>
    </div>
    <div class="gauge-card">
      <div class="gauge-visual">
        <div class="hcl-tank">
          <div class="hcl-fill" id="hcl-fill"></div>
        </div>
      </div>
      <div class="gauge-value" id="val-hcl">--</div>
      <div class="gauge-label">HCl (mL)</div>
    </div>
  </section>

  <section class="charts">
    <div class="tab-bar">
      <button class="tab active" data-tab="kh">KH</button>
      <button class="tab" data-tab="ph">pH</button>
      <button class="tab" data-tab="live">Live pH</button>
      <button class="tab" data-tab="gran">Gran</button>
    </div>
    <div id="kh-method-toggle" class="kh-method-toggle">
      <button class="kh-method-btn active" data-method="combined">Combined</button>
      <button class="kh-method-btn" data-method="gran">Gran</button>
      <button class="kh-method-btn" data-method="endpoint">Endpoint</button>
    </div>
    <div id="gran-subtabs" class="gran-subtabs" style="display:none">
      <button id="gran-tab-last" class="gran-subtab active">Last</button>
      <button id="gran-tab-hist" class="gran-subtab">History</button>
    </div>
    <div class="chart-container">
      <canvas id="chart-kh"></canvas>
      <canvas id="chart-ph" style="display:none"></canvas>
      <canvas id="chart-live" style="display:none"></canvas>
      <canvas id="chart-gran" style="display:none"></canvas>
      <canvas id="chart-gran-hist" style="display:none"></canvas>
    </div>
    <div id="kh-trend" class="chart-sub">Trend: <strong id="val-kh-slope">--</strong> dKH/day</div>
    <div id="gran-info" class="gran-info" style="display:none"></div>
    <div id="gran-quality" class="gran-quality" style="display:none">
      <span>Confidence: <strong id="val-confidence">--</strong></span>
    </div>
  </section>

  <section class="progress-section" id="progress-section" style="display:none">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    <div class="progress-label" id="progress-label">0%</div>
  </section>

  <section class="buttons collapsible">
    <h2 class="section-header">Commands <span class="chevron"></span></h2>
    <div class="section-body">
      <div class="btn-row-primary">
        <button class="cmd-btn primary" data-cmd="k">Measure KH</button>
        <button class="cmd-btn primary" data-cmd="p">Measure pH</button>
      </div>
      <div class="btn-grid">
        <button class="cmd-btn" data-cmd="s">Cal Sample</button>
        <button class="cmd-btn" data-cmd="t">Cal Titration</button>
        <button class="cmd-btn" data-cmd="f">Fill</button>
        <button class="cmd-btn cal" data-cmd="4">Cal pH 4</button>
        <button class="cmd-btn cal" data-cmd="7">Cal pH 7</button>
        <button class="cmd-btn cal" data-cmd="10">Cal pH 10</button>
        <button class="cmd-btn warn btn-full" data-cmd="o">Restart</button>
      </div>
    </div>
  </section>

  <section class="config collapsible">
    <h2 class="section-header">Configuration <span class="chevron"></span></h2>
    <div class="section-body">
      <div class="config-grid">
        <label>HCl Molarity (mol/L)
          <input type="number" id="cfg-hcl_molarity" step="0.001" min="0.001" max="1">
        </label>
        <label>HCl Volume (mL)
          <input type="number" id="cfg-hcl_volume" step="1" min="0" max="5000">
        </label>
        <label>Titration Vol (mL)
          <input type="number" id="cfg-titration_vol" step="0.1" min="0.1" max="50">
        </label>
        <label>Sample Vol (mL)
          <input type="number" id="cfg-sample_vol" step="0.1" min="1" max="200">
        </label>
        <label>Correction Factor
          <input type="number" id="cfg-correction_factor" step="0.01" min="0.5" max="2">
        </label>
      </div>
      <details class="config-advanced">
        <summary>Advanced</summary>
        <div class="config-grid">
          <label>Calibration Units
            <input type="number" id="cfg-cal_drops" step="100" min="1000" max="20000">
          </label>
          <label>Fast Titration pH
            <input type="number" id="cfg-fast_ph" step="0.1" min="4.5" max="7.0">
          </label>
          <label>Endpoint Method
            <select id="cfg-endpoint_method">
              <option value="0">Gran</option>
              <option value="1">Fixed pH</option>
            </select>
          </label>
          <label>Min Start pH
            <input type="number" id="cfg-min_start_ph" step="0.1" min="6.0" max="9.0">
          </label>
          <label>Stabilization Timeout (ms)
            <input type="number" id="cfg-stab_timeout" step="100" min="500" max="5000">
          </label>
          <label>Gran Mix Delay (ms)
            <input type="number" id="cfg-gran_mix_delay" step="100" min="500" max="5000">
          </label>
          <label>Drop Volume (µL)
            <input type="number" id="cfg-drop_ul" step="1" min="5" max="200">
          </label>
          <label>Ejection Speed (RPM)
            <input type="number" id="cfg-titration_rpm" step="1" min="10" max="150">
          </label>
          <label>Prefill Volume (µL)
            <input type="number" id="cfg-prefill_ul" step="10" min="10" max="500">
          </label>
        </div>
      </details>
    </div>
  </section>

  <section class="schedule collapsible">
    <h2 class="section-header">Schedule <span class="chevron"></span></h2>
    <div class="section-body">
      <div class="sched-mode-toggle" id="sched-mode-toggle">
        <button class="sched-mode-btn active" data-mode="0">Custom</button>
        <button class="sched-mode-btn" data-mode="1">Interval</button>
      </div>

      <div id="sched-custom-panel">
        <div class="sched-grid" id="sched-grid"></div>
        <button class="sched-add-btn" id="sched-add" title="Add schedule slot">+ Add</button>
      </div>

      <div id="sched-interval-panel" style="display:none">
        <div class="interval-config">
          <label>Every
            <select id="sched-interval-hours">
              <option value="1">1 hour</option>
              <option value="2">2 hours</option>
              <option value="3">3 hours</option>
              <option value="4">4 hours</option>
              <option value="6" selected>6 hours</option>
              <option value="8">8 hours</option>
              <option value="12">12 hours</option>
              <option value="24">24 hours</option>
            </select>
          </label>
          <label>Anchor Time
            <input type="time" id="sched-anchor-time" value="06:00">
          </label>
        </div>
        <div class="interval-preview" id="interval-preview"></div>
      </div>

      <div class="next-meas">Next: <span id="next-meas">--</span></div>
    </div>
  </section>

  <section class="event-log">
    <h2>Event Log</h2>
    <div class="log-container" id="log-container"></div>
  </section>

  <section class="probe-health collapsible collapsed">
    <h2 class="section-header">Probe Health <span class="chevron"></span></h2>
    <div class="section-body">
      <div class="probe-grid">
        <div class="probe-item">
          <span class="probe-label">Status</span>
          <span class="probe-value" id="probe-health"><span class="health-dot"></span>--</span>
        </div>
        <div class="probe-item">
          <span class="probe-label">Acid Slope</span>
          <span class="probe-value" id="probe-acid-eff"><span class="health-dot"></span>--</span>
        </div>
        <div class="probe-item">
          <span class="probe-label">Alk Slope</span>
          <span class="probe-value" id="probe-alk-eff"><span class="health-dot"></span>--</span>
        </div>
        <div class="probe-item">
          <span class="probe-label">Asymmetry</span>
          <span class="probe-value" id="probe-asymmetry">-- <small>%</small></span>
        </div>
        <div class="probe-item">
          <span class="probe-label">Noise</span>
          <span class="probe-value" id="probe-noise"><span class="health-dot"></span>--</span>
        </div>
        <div class="probe-item">
          <span class="probe-label">Cal Age</span>
          <span class="probe-value" id="probe-cal-age">--</span>
        </div>
      </div>
      <div class="probe-chart-container">
        <canvas id="chart-efficiency"></canvas>
      </div>
      <div class="probe-chart-container">
        <canvas id="chart-noise"></canvas>
      </div>
    </div>
  </section>

  <section class="status-bar">
    <div><strong>RSSI:</strong> <span id="rssi">--</span> dBm</div>
    <div><strong>Uptime:</strong> <span id="uptime">--</span></div>
    <a class="export-btn" href="/api/export.csv" download="kh_history.csv">Export CSV</a>
    <a class="export-btn" href="/api/diagnostics" download="kh_diagnostics.json">Diagnostics</a>
  </section>

  <script src="chart.min.js?v=2"></script>
  <script src="app.js?v=5"></script>
</body>
</html>
